{% extends "base.html" %}

{% block content %}
<style>

.toggled {
  background-color: #dedede;
}

a.ai_selection,
a.map_selection {
  text-decoration: none;
  color: #000;
}

a.ai_selection:visited,
a.map_selection:visited {
  color: #000;
}

.ai_selection,
.map_selection {
  width: 100%;
  display: block;
  padding: 5px;
  margin-right: 5px;
}

.ai_selection:hover,
.map_selection:hover {
  background-color: #ceceff;
}


.map_selection {
  float: left;
  clear: left;
}

#close_controls {
  cursor: pointer;
  display: block;
  margin-bottom: 15px;
}

#controls {
  padding-bottom: 25px;
}

#controls h3 {
  text-size: 140%;
  margin: 10px 0;
}

#sort_reverse {
  display: block;
  cursor: pointer;
  float: right;
  margin-top: 5px;
  padding: 10px;
  margin-bottom: 25px;
  border: 2px dotted black;
}
#sort_order {
  float: left;
}

#sort_controls {
  float: left;
}

#sort_controls ol {
}

#sort_controls li {
  text-decoration: none;
  padding: 5px;
  margin: 5px 0;
  padding-left: 25px;
  background-color: #dedede;
  cursor: pointer;
}
#sort_controls li:hover {
  background-color: #ceceff;
}


#ai_controls {
}


#game_run_collection {
  clear: both;
}

.game_run_content {
  border: 2px dashed #000; }

.game_run {
  position: relative;
  display: inline-block;
  margin-bottom: 25px;
  padding-bottom: 15px;
}

.game_run .info {
  padding: 0 10px;
  margin-bottom: 5px;
}


.game_run .map {
  background-color: #000;
  color: #fff;
  text-align: center;
  padding: 5px;
  margin: 0px;
  font-size: 24px;
}

.game_run .map a {
  color: #fff;
  text-decoration: none;
}
.game_run .map a:hover {
  color: #00ff00;
}

.game_run .map .delete {
  float: right;
  margin-right: 5px;
}

.game_run .map .delete:hover {
  color: #ff0000;
}


.game_run .ai_participants {
  height: 125px;
  overflow: hidden;
  position: relative;
  padding-top: 30px;
}

.game_run .ai_participant {
  width: 100%;
}

.game_run .winner {
  background-color: #eeffee;
  font-size: 20px;
  height: 30px;
  position: absolute;
  top: 0px;
  width: 100%;
  padding: 0px;
}

.game_run .ai_participant .ai_class_name {
  margin-left: 5px;
}
.game_run .ai_participant .deaths {
  margin-right: 5px;
}

.game_run .loser {
  font-size: 12px;
}

.game_run .runtime {
  float: right;
  text-decoration: none;
  font-weight: normal;
}

.game_run .ai_class_name {
  float: left;
  overflow: hidden;
}



.game_run .kills {
  color: #000000;
}
.game_run .deaths {
  color: #ff0000;
}

.game_run .kills,
.game_run .deaths {
  width: 30px;
  float: right;
  text-align: right;
}

.game_run .playtime_ago {
  float: right;
}

.game_run .game_version {
  display: inline-block;
}


</style>


<body class="container_12">

<div id="controls" class="clearfix">
  <div id="map_controls" class="grid_4">
    <h3 style="float: left;">Map: (Click to Select)</h3>
    <a class="map_selection" map_name="" href="#">
      all
    </a>
    {% for m in maps %}
    <a class="map_selection" map_name="{{m}}" href="#">
      {{ m }}
    </a>
    {% endfor %}
  </div>

  <div id="ai_controls" class="clearfix grid_4">
    <h3 >Files (Click to Toggle): </h3>
    {% for a in ai_files %}
    <a class="ai_selection" ai_name="{{a}}" href="#">
      {{ a }}
    </a>
    {% endfor %}
  </div>

  <div id="sort_controls" class="clearfix grid_4">

    <h3 >Sort By (Drag to change ordering): </h3>
    <ol id="sort_order" class="grid_4">
    </ol>
  </div>

</div>

<div class="clearfix grid_12">
  <a id="sort_reverse"> Reverse Results</a>
  <a id="close_controls">^ Hide Controls ^</a>
</div>

<div id="game_run_collection"></div>

<div id="game_runs" class="hidden">
{% for gr in game_runs %}
  <div class="game_run grid_4"
       data-id="{{gr.key}}"
       map_name="{{gr.map_name}}"
       turns="{{gr.turns}}"
       num_ai="{{gr.aiparticipant_set.count}}"
       created_at="{{gr.created_at}}" >
    <div class="game_run_content">
      <h2 class="map">
      <a class="replay" href="/replays/{{ gr.replay.key }}">
        {{gr.map_name}} 
      </a>
      {% if can_delete %}
        <a class="delete" href="/delete">x</a>
      {% endif %}
      </h2>


      <div class="ai_participants">
        {% for ai in gr.aiparticipant_set %}
        <div class="ai_participant {% if ai.win %}winner{%else%}loser{%endif%} clearfix" file_name="{{ai.file_name}}">
           <div class="ai_class_name"
                 title="{{ ai.file_name }}:{{ ai.version }}">
              {{ ai.class_name|truncate:14 }}
           </div>

          <div class="deaths"> {{ ai.deaths }} </div>
          <div class="kills"> {{ ai.kills }} </div>
        </div>
        {% endfor %}
      </div>

      <div class="info">
      <h2 class="turns">
        {{gr.turns}} Turns
        <span class="runtime">
          ({{gr.run_time|floatformat:2}}s)
        </span>
      </h2>
      <div class="game_version">
        version: {{ gr.version|truncate:6 }}
      </div>
      <div class="playtime_ago"
           title="{{gr.created_at|date}} {{ gr.created_at|time }}">
        {{gr.created_at|timesince}} ago
      </div>
      </div>
    </div> <!-- Game Run Content -->
  </div> <!-- Game Run -->

{% endfor %}
</div>

<script src="https://github.com/jamespadolsey/jQuery-Plugins/raw/master/sortElements/jquery.sortElements.js" type="text/javascript"></script>

<script type='text/javascript'>
  $(function() {

    $.fn.reverse = [].reverse;


    // Keep track of filtering AIs
    var sortOrder = [];
    var sortReverse = false;
    var filterFiles = [];
    var map = null;

    var filterGames = function(games) {
      if (games == null) { games = $("#game_runs .game_run"); }

      // Filter games, first
      visible_games = games.filter(function() {
        if (map && $(this).attr("map_name")!=map) {
          return false;
        }

        if (filterFiles) {
          // Must contain all AIs that are clicked on
          var gameAIs = $(this).find(".ai_participant");
          var ai_files = $.map(gameAIs, function(el) {
            return $(el).attr("file_name")
          });

          var containsAllAI = true;
          $.each(filterFiles, function() {
            var file = String(this);
            if ( $.inArray(file, ai_files) == -1) { // For the jquery inArray
              containsAllAI = false;
            }
          });

          if (!containsAllAI) { return false; }
        }

        return true;
      });


      // Now sort games
      visible_games.sort(function(a, b) {
        for (i in sortOrder) {
          var func = sortComparators[sortOrder[i]],
              r = func(a,b);

          if (r != 0) { return r; }
        };
        return 0;
      });

      if (sortReverse) { visible_games.reverse(); }

      $("#game_run_collection").quicksand(visible_games);
    }

    $(".ai_selection").toggle(
      function() {
        var fileName = $(this).attr("ai_name");
        filterFiles.push(fileName);
        $(this).addClass("toggled");
        filterGames();
      },
      function() {
        var fileName = $(this).attr("ai_name");
        filterFiles = $.grep(filterFiles, function(el, index) { return el != fileName; });

        $(this).removeClass("toggled");
        filterGames();

      }
    );

    $(".map_selection").click(function() {
      map = $(this).attr("map_name");
      $(".map_selection").removeClass("toggled");
      $(this).addClass("toggled");

      filterGames();
    });

    var attrCompare = function(a,b,attr) {
      var a_attr = $(a).attr(attr);
      var b_attr = $(b).attr(attr);
      if (a_attr == b_attr) { return 0; }
      if (a_attr < b_attr) { return -1; }
      return 1;
    }

    var attrIntCompare = function(a,b,attr) {
      var a_attr = parseInt($(a).attr(attr));
      var b_attr = parseInt($(b).attr(attr));
      if (a_attr == b_attr) { return 0; }
      if (a_attr < b_attr) { return -1; }
      return 1;
    };

    var sort_ways = [
      ["Winner", function(a, b) {
        return attrCompare($(a).find(".ai_participant.winner"),
                           $(b).find(".ai_participant.winner"),
                           "file_name");
        }],
      ["Map", function(a, b) {
        return attrCompare(a,b,"map_name");
        }],
      ["Game Length", function(a, b) {
        return attrIntCompare(a,b,"turns");
        }],
      ["Number of AI", function(a, b) {
        return attrIntCompare(a,b,"num_ai");
        }],
      ["Age", function(a, b) {
        return attrIntCompare(a,b,"created_at");
        }]
    ]

    var sortComparators = {};

    $.each(sort_ways, function() {
      var el = this;
      sortComparators[el[0]] = el[1];
      $("#sort_order").append($("<li key='"+el[0]+"'>"+el[0]+"</li>"));
      sortOrder.push(el[0]);
    });

    $("#sort_order").sortable({
      stop: function(event, ui) {
        var keyOrder = $(this).children().map(function() { return $(this).attr("key") });
        sortOrder = $.makeArray(keyOrder);
        filterGames();
      }
    });

    $("#sort_reverse").toggle(function() {
      $(this).addClass("toggled");
      sortReverse = true;
      filterGames();
    }, function() {
      $(this).removeClass("toggled");
      sortReverse = false;
      filterGames();
    });

    $("#close_controls").toggle(function() {
      $(this).html("v Show Controls v");
      $("#controls").fadeOut(400);
    }, function() {
      $(this).html("^ Hide Controls ^");
      $("#controls").fadeIn();
    });

    $(".game_run a.delete").live('click', function(e) {
      var gr = $(this).parents(".game_run"),
          url = $(this).attr("href"),
          id  = gr.attr("data-id");
      $.ajax(url, {
        data : { game_run : id },
        success : function() {
          var grs = $(".game_run[data-id="+id+"]");
          grs.remove();},
        type : "POST",
      });

      e.preventDefault();
    });

    $("#game_run_collection").quicksand($("#game_runs .game_run"));
  });
</script>

{% endblock content %}
